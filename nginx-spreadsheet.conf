events {
    worker_connections 1024;
}

http {
    upstream spreadsheet_backend {
        server spreadsheet-processor:8000;
    }

    upstream transcribe_backend {
        server transcribe:8000;
    }

    upstream pdf_backend {
        server pdf-processor:8000;
    }

    server {
        listen 80;
        server_name _;

        client_max_body_size 50M;
        proxy_read_timeout 300s;
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;

        # Rotas para processamento de planilhas
        location /spreadsheet/ {
            rewrite ^/spreadsheet/(.*) /$1 break;
            proxy_pass http://spreadsheet_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Rotas específicas para planilhas
        location /extract-spreadsheet {
            proxy_pass http://spreadsheet_backend/extract-spreadsheet;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /analyze-spreadsheet {
            proxy_pass http://spreadsheet_backend/analyze-spreadsheet;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /extract-and-send-to-n8n {
            proxy_pass http://spreadsheet_backend/extract-and-send-to-n8n;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Rotas para transcrição de áudio/vídeo
        location /transcribe {
            proxy_pass http://transcribe_backend/transcribe;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /transcribe-simple {
            proxy_pass http://transcribe_backend/transcribe-simple;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Rotas para processamento de PDF
        location /extract {
            proxy_pass http://pdf_backend/extract;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /extract-structured {
            proxy_pass http://pdf_backend/extract-structured;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Health checks
        location /health/spreadsheet {
            proxy_pass http://spreadsheet_backend/health;
        }

        location /health/transcribe {
            proxy_pass http://transcribe_backend/health;
        }

        location /health/pdf {
            proxy_pass http://pdf_backend/health;
        }

        # Página inicial
        location / {
            return 200 '{
                "status": "ok",
                "services": {
                    "spreadsheet": "/spreadsheet/",
                    "transcribe": "/transcribe",
                    "pdf": "/extract"
                },
                "health_checks": {
                    "spreadsheet": "/health/spreadsheet",
                    "transcribe": "/health/transcribe",
                    "pdf": "/health/pdf"
                }
            }';
            add_header Content-Type application/json;
        }
    }
}
